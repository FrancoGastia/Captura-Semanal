name: Captura semanal Despegar

on:
  schedule:
    - cron: '0 9 * * 1'  # Lunes 9am UTC (6am Argentina)
  workflow_dispatch:

jobs:
  screenshot:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: ğŸ“¥ Clonar repositorio
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT }}

    - name: ğŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ğŸ› ï¸ Instalar Puppeteer y dependencias
      run: |
        npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth

    - name: ğŸ“¸ Ejecutar captura
      run: |
        echo "ğŸš€ Iniciando captura..."
        node capture.js

    - name: ğŸ” Verificar captura generada
      run: |
        if [ -d "screenshots" ] && [ "$(ls -A screenshots)" ]; then
          echo "âœ… Capturas encontradas:"
          ls -la screenshots/
        else
          echo "âŒ No se encontraron capturas"
          exit 1
        fi

    - name: ğŸ’¾ Commit de resultados
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions Bot"
        git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}
        
        git add screenshots/ || true
        
        if git diff --staged --quiet; then
          echo "ğŸ“ No hay cambios que commitear"
        else
          git commit -m "ğŸ“¸ Captura automÃ¡tica - $(date +'%Y-%m-%d')"
          git push origin HEAD
        fi
