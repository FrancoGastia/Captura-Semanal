name: Captura semanal Despegar - Stealth Avanzado

on:
  schedule:
    - cron: '0 9 * * 1'  # Lunes 9am UTC (6am Argentina)
  workflow_dispatch:

jobs:
  screenshot:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    strategy:
      fail-fast: false
      matrix:
        attempt: [1, 2]  # Dos intentos con diferentes configuraciones

    steps:
    - name: ğŸ“¥ Clonar repositorio
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT }}

    - name: ğŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ğŸ› ï¸ Instalar dependencias stealth
      run: |
        npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth

    - name: â° Delay aleatorio inicial (simular humano)
      run: |
        delay=$((RANDOM % 300 + 60))  # Entre 1-5 minutos aleatorio
        echo "ğŸ• Esperando $delay segundos para simular comportamiento humano..."
        sleep $delay

    - name: ğŸ“¸ Ejecutar captura stealth avanzada
      run: |
        echo "ğŸš€ Iniciando captura stealth - Intento ${{ matrix.attempt }}..."
        node capture.js
      env:
        NODE_OPTIONS: '--max-old-space-size=6144'
        ATTEMPT_NUMBER: ${{ matrix.attempt }}

    - name: ğŸ” Verificar y analizar captura
      run: |
        if [ -d "screenshots" ] && [ "$(ls -A screenshots)" ]; then
          echo "âœ… Capturas encontradas:"
          ls -la screenshots/
          
          # Verificar tamaÃ±o y contenido
          for file in screenshots/*.png; do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file")
              echo "ğŸ“ TamaÃ±o de $file: $size bytes"
              
              # Si la imagen es muy pequeÃ±a, probablemente fue bloqueada
              if [ $size -lt 50000 ]; then
                echo "âš ï¸ ADVERTENCIA: Captura muy pequeÃ±a - posible bloqueo"
                echo "ğŸ” Verificando contenido de la captura..."
              else
                echo "âœ… Captura de tamaÃ±o normal - probablemente exitosa"
              fi
            fi
          done
        else
          echo "âŒ No se encontraron capturas"
          exit 1
        fi

    - name: ğŸ“Š Generar reporte detallado
      run: |
        mkdir -p reports
        timestamp=$(date +'%Y-%m-%d %H:%M:%S')
        echo "# ğŸ“¸ Reporte Captura Stealth - $timestamp" > reports/reporte-${{ matrix.attempt }}.md
        echo "" >> reports/reporte-${{ matrix.attempt }}.md
        echo "## ğŸ¯ InformaciÃ³n del Intento" >> reports/reporte-${{ matrix.attempt }}.md
        echo "- **Intento**: ${{ matrix.attempt }}" >> reports/reporte-${{ matrix.attempt }}.md
        echo "- **Fecha**: $timestamp UTC" >> reports/reporte-${{ matrix.attempt }}.md
        echo "- **Workflow Run**: ${{ github.run_id }}" >> reports/reporte-${{ matrix.attempt }}.md
        echo "- **Estrategia**: Stealth Avanzado con delays humanizados" >> reports/reporte-${{ matrix.attempt }}.md
        echo "" >> reports/reporte-${{ matrix.attempt }}.md
        
        if [ -d "screenshots" ]; then
          echo "## ğŸ“ Resultados" >> reports/reporte-${{ matrix.attempt }}.md
          for file in screenshots/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              size=$(wc -c < "$file")
              
              if [ $size -lt 50000 ]; then
                status="âš ï¸ POSIBLE BLOQUEO"
              else
                status="âœ… EXITOSA"
              fi
              
              echo "- **$filename**: $size bytes - $status" >> reports/reporte-${{ matrix.attempt }}.md
            fi
          done
        fi

    - name: ğŸ’¾ Commit resultados con anÃ¡lisis
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions Stealth Bot"
        git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}
        
        git add screenshots/ reports/ || true
        
        if git diff --staged --quiet; then
          echo "ğŸ“ No hay cambios que commitear"
        else
          timestamp=$(date +'%Y-%m-%d %H:%M:%S')
          
          # Verificar si la captura parece exitosa
          success_status="ğŸ¯"
          if [ -f screenshots/*.png ]; then
            size=$(wc -c < screenshots/*.png 2>/dev/null || echo "0")
            if [ $size -gt 50000 ]; then
              success_status="âœ… Ã‰XITO"
            else
              success_status="âš ï¸ POSIBLE BLOQUEO"
            fi
          fi
          
          git commit -m "$success_status Captura Stealth - $timestamp

          ğŸ¤– Bot: GitHub Actions Stealth
          ğŸ“… Fecha: $timestamp UTC  
          ğŸ¯ Intento: ${{ matrix.attempt }}
          ğŸ”¬ TÃ©cnicas: Anti-detecciÃ³n avanzada, delays humanizados
          ğŸŒ Target: Despegar Hoteles Argentina"
          
          git push origin HEAD || echo "Push fallÃ³, continuando..."
        fi

    - name: ğŸ“¤ Subir evidencia para anÃ¡lisis
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: evidencia-stealth-${{ matrix.attempt }}
        path: |
          screenshots/
          reports/
        retention-days: 14
