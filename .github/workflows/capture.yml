name: Captura semanal Despegar

on:
  schedule:
    - cron: '0 9 * * 1'  # Lunes 9am UTC (6am Argentina)
  workflow_dispatch:

jobs:
  screenshot:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
    - name: ğŸ“¥ Clonar repositorio
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GH_PAT }}

    - name: ğŸ”§ Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ğŸ› ï¸ Instalar dependencias
      run: |
        npm install puppeteer puppeteer-extra puppeteer-extra-plugin-stealth

    - name: ğŸ” Instalar dependencias del sistema
      run: |
        sudo apt-get update
        sudo apt-get install -y           gconf-service libasound2 libatk1.0-0 libc6 libcairo2           libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1           libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0           libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6           libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1           libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2           libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation           libappindicator1 libnss3 lsb-release xdg-utils wget

    - name: ğŸ“¸ Ejecutar captura
      run: |
        echo "ğŸš€ Iniciando captura..."
        node capture.js

    - name: ğŸ” Verificar captura generada
      run: |
        if [ -d "screenshots" ] && [ "$(ls -A screenshots)" ]; then
          echo "âœ… Capturas encontradas:"
          ls -la screenshots/
        else
          echo "âŒ No se encontraron capturas"
          exit 1
        fi

    - name: ğŸ’¾ Commit y push de resultados
      env:
        GH_TOKEN: ${{ secrets.GH_PAT }}
      run: |
        git config --global user.email "actions@github.com"
        git config --global user.name "GitHub Actions Bot"
        git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}
        
        git add screenshots/ || true
        
        if git diff --staged --quiet; then
          echo "ğŸ“ No hay cambios que commitear"
        else
          timestamp=$(date +'%Y-%m-%d %H:%M:%S')
          git commit -m "ğŸ“¸ Captura automÃ¡tica - $timestamp"
          git push origin HEAD
        fi
